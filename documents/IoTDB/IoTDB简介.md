# IoTDB简介

### 一、IoTDB是什么

Apache IoTDB（物联网数据库）是一种高性能的IoT本地数据库，可进行数据管理和分析，可部署在边缘和云上。由于其轻巧的架构，高性能和丰富的功能集以及与Apache Hadoop，Spark和Flink的深度集成，Apache IoTDB可以满足工业物联网领域中对海量数据存储，高速数据提取和复杂数据分析的需求。

### 二、IoTDB的使用场景

先了解下物联网中时序数据的生命周期，如下图。

![ApacheIoTDB时序数据生命周期](.\img\ApacheIoTDB时序数据生命周期.jpg)

IoTDB整套产品，考虑到了整个使用链条，整体形成了IoTDB套件，见下图。

![IoTDB套件](.\img\IoTDB套件.png)

```
用户可以使用JDBC将设备上的传感器收集的时间序列数据导入本地/远程IoTDB。这些时间序列数据可以是系统状态数据（例如服务器负载和CPU内存等），消息队列数据，来自应用程序的时间序列数据或数据库中的其他时间序列数据。用户还可以将数据直接写入TsFile（本地或在HDFS上）。
可以将TsFile写入HDFS，从而在Hadoop或Spark数据处理平台上执行数据处理任务，例如异常检测和机器学习。
对于写入HDFS或本地TsFile的数据，用户可以使用TsFile-Hadoop-Connector或TsFile-Spark-Connector允许Hadoop或Spark处理数据。
分析结果可以用相同的方式写回TsFile。
此外，IoTDB和TsFile提供客户端工具，以满足用户以SQL形式，脚本形式和图形形式编写和查看数据的各种需求。
```

![IOTDB使用场景](.\img\IOTDB使用场景.png)

上图是https://iotdb.apache.org/官网使用场景配图，从左到右分别对应”大型高端制造设备“，”本地机械臂控制服务器“和”汽车车载传感器“三种使用场景。

----------------------------------------------------------

```
场景1（大型高端制造设备）：在高端制造业中，有很多设备配备有传感器来收集工作状态数据，如风力涡轮机，这些设备如果配备了嵌入式控制器（如树莓派），则可以运行TsFile在本地存储数据。通过这种方式，TsFile可以提供具有高吞吐量，高压缩率和毫秒查询的数据保存功能。与TsFile-Sync工具一起，TsFiles可以传输到数据中心。
```

*<u>ps：这种场景在机子上搭建了IoTDB数据库，自己可以一定程度上执行数据的清洗及存储工作，应该属于边缘计算。</u>*

------------------------------------------------------------------------------------

```
场景2（本地机械臂控制服务器）：在工厂现场，LAN网络下有数十台机械臂设备。IoTDB可以安装在工厂的本地控制器服务器上（一般是工作站），以从这些设备接收数据。其可以使用类似于SQL的界面来保留数据和查询数据。此外，使用TsFile-Sync工具，可以将本地控制器上的TsFiles传输到云中配备IoTDB实例的数据中心。
```

*<u>ps：这种场景在整个工厂或车间的中控机上安装了IoTDB，以工厂或车间为单位，可以执行数据清洗及存储工作，然后再传输到云端数据中心。</u>*

-------------------------------------------------------------------------------------------------

```
场景3（车联网）：在高速网络（车辆互联网等）的场景中，装有传感器的汽车可以一定频率收集其自身的监视信息（行驶状态等）。通常，这些汽车设备的硬件配置有限，并且难以进行复杂的应用。在这里，轻量级的IoTDB（IoTDB客户端）应运而生。IoTDB的JDBC API可以使数据尽可能通过窄带IoT网络或4G发送。这样，设备和云便连接在一起。
```

*<u>ps：这种场景下，由于没有车载的强运算设备，导致无法安装IoTDB，只能将数据上报到云端进行处理，但IoTDB应该对数据的上传进行了一定的优化。</u>*

--------------------------------------------------------------

最后是云端，图中可见IoTDB与多种大数据分析生态进行了集成，如Hadoop，spark等。

### 三、IoTDB特性

如下图，目前目前时序数据库有30多个，从架构的角度又可以分为三大类

第一类，以<font color=orange>TimescaleDB</font>为代表基于关系的时序数据库

第二类，以<font color=green>OpenTSDB</font>为代表的基于KV的时序数据库

第三类，专门为时序数据数据而生的 <font color=red>InfluxDB</font>和<font color=red>Apache IoTDB</font>

![IOTDB排名](.\img\IOTDB排名.png)

官方文档有对于这三类数据库的比较试验，下图为试验结果：

<img src=".\img\IoTDB试验1.png" alt="IoTDB试验1" style="zoom:80%;" />

*写入吞吐量（点/秒）*

<img src=".\img\IoTDB试验2.png" alt="IoTDB试验2" style="zoom: 80%;" />

*磁盘占用量（GB）*

<img src=".\img\IoTDB试验3.png" alt="IoTDB试验3" style="zoom: 67%;" />

*聚合查询时间成本（毫秒）*

可以看到IoTDB在性能上完胜其它数据库。官方也有其它更详细的测试方案及性能比较，请参阅https://iotdb.apache.org/UserGuide/V0.11.x/Comparison/TSDB-Comparison.html。

------------------------------------------

下表比较了常用时序数据库的特性。

| TSDB                      | IoTDB                   | InfluxDB                 | OpenTSDB     | KairosDB           | TimescaleDB     |
| ------------------------- | ----------------------- | ------------------------ | ------------ | ------------------ | --------------- |
| OpenSource                | **O**（apache2.0）      | o（MIT，集群版本不开源） | o（LGPL2.1） | **O**（apache2.0） | o（企业级收费） |
| SQL-like                  | o                       | o                        | x            | x                  | **O**           |
| Schema                    | "Tree-based, tag-based" | tag-based                | tag-based    | tag-based          | Relational      |
| Writing out-of-order data | o                       | o                        | o            | o                  | o               |
| Schema-less               | o                       | o                        | o            | o                  | o               |
| Batch insertion           | o                       | o                        | o            | o                  | o               |
| Time range filter         | o                       | o                        | o            | o                  | o               |
| Order by time             | **O**                   | o                        | x            | x                  | o               |
| Value filter              | o                       | o                        | x            | x                  | o               |
| Downsampling              | **O**                   | o                        | o            | o                  | o               |
| Fill                      | **O**                   | o                        | o            | x                  | o               |
| LIMIT                     | o                       | o                        | o            | o                  | o               |
| SLIMIT                    | o                       | o                        | x            | x                  | ?               |
| Latest value              | O                       | o                        | o            | x                  | o               |

总的来说，如果我们比较基本功能，我们会发现OpenTSDB和KairosDB在某种程度上缺少一些重要的查询功能。TimescaleDB不能在业务中自由使用。IoTDB和InfluxDB可以满足时间序列数据管理的大多数要求，尽管它们之间存在一些差异。

---------------------------------------

根据IoTDB的开源文档，IoTDB有以下特点：

```
1.灵活的部署策略。IoTDB为用户提供了一个在云平台或终端设备上的一键安装工具，以及一个连接云平台和终端上的数据的数据同步工具。
2.硬件成本低。IoTDB可以达到很高的磁盘存储压缩比。
3.高效的目录结构。IoTDB支持智能网络设备对复杂时间序列数据结构的高效组织，同类设备对时间序列数据的组织，海量复杂时间序列数据目录的模糊搜索策略。
4.高吞吐量读写。IoTDB支持数以百万计的低功耗设备的强连接数据访问、高速数据读写，适用于上述智能网络设备和混合设备。
5.丰富的查询语义。IoTDB支持跨设备和测量的时间序列数据的时间对齐、时间序列字段的计算(频域转换)和时间维度的丰富聚合函数支持。
6.学习成本非常低。IoTDB支持类似sql的语言、JDBC标准API和易于使用的导入/导出工具。
7.与先进的开放源码生态系统的无缝集成。IoTDB支持分析生态系统，如Hadoop、Spark和可视化工具(如Grafana)。
```

<u>*ps：在github上可以找到官方go语言版本的IoTDB-client，但是IoTDB-server的的部署必须需要java环境*</u>

### 四、IoTDB概念

#### 数据模型

![IoTDB数据模型](.\img\IoTDB数据模型.jpg)

如上图，从上到下的层次结构是：`电源组层-电厂层-设备层-传感器层`。ROOT是根节点，传感器层的每个节点都是叶节点。在使用IoTDB的过程中，来自ROOT节点的路径上的属性使用`“.”`直接连接到每个叶节点，从而在IoTDB中形成了时间序列的名称。例如，图中最左侧的路径可以生成一个名为`ROOT.ln.wf01.wt01.status`的时间序列。

#### 数据分类

获取时间序列的名称后，我们需要根据实际情况和数据规模来设置存储组。在本章的情况下，数据通常以组为单位到达（即，数据可能跨越电场和设备），以避免在写入数据时频繁切换IO，并满足用户对物理隔离的要求。数据以组为单位，存储组设置在组层。

以下是IoTDB中涉及的模型的基本概念：

- Device(设备)

设备是在实际情况下配备传感器的安装。在IoTDB中，所有传感器都应具有其相应的设备。

- Sensor(测点)

传感器是实际场景中的检测设备，可以感知要测量的信息，可以将感知到的信息转换为电信号或其他所需形式的信息输出，并将其发送到IoTDB。在IoTDB中，所有存储的数据和路径均以传感器为单位进行组织。

- Storage Group(储存组)

存储组用于让用户定义如何在磁盘上组织和隔离不同的时间序列数据。属于同一存储组的时间序列将连续写入到相应文件夹中的同一文件中。该文件可能由于用户命令或系统策略而关闭，因此来自这些传感器的下一个数据将存储在同一文件夹中的新文件中。属于不同存储组的时间序列存储在不同的文件夹中。

用户可以将任何前缀路径设置为存储组。只要有四个时间序列`root.vehicle.d1.s1`，`root.vehicle.d1.s2`，`root.vehicle.d2.s1`，`root.vehicle.d2.s2`，两个设备`d1`和`d2`路径下`root.vehicle`可能属于同一所有人或同一厂家，所以D1和D2是密切相关的。此时，可以将前缀路径root.vehicle指定为存储组，这将使IoTDB将其下的所有设备存储在同一文件夹中。下的新添加的设备`root.vehicle`也将属于该存储组。

> 注意：`root.vehicle.d1.s1`不允许将完整路径（如上例所示）设置为存储组。

设置合理数量的存储组可以提高性能：不会由于过多的IO频繁切换（这也将占用大量内存并导致频繁的内存文件切换）而导致系统速度下降存储文件（或文件夹），也不会因存储文件（或文件夹）太少而导致写入命令阻塞（这会降低并发性）。

用户应根据自己的数据大小和使用方案平衡存储文件的存储组设置，以实现更好的系统性能。（将来将正式提供存储组规模和性能测试报告）。

> 注意：时间序列的前缀必须属于一个存储组。在创建时间序列之前，用户必须设置时间序列所属的存储组。只有设置了存储组的时间序列可以保留在磁盘上。

> 注意：一旦将前缀路径设置为存储组，就无法更改存储组设置。

设置存储组后，不允许再次设置相应前缀路径的所有父层和子层（例如，在`root.ln`设置为存储组之后，`root.ln.wf01`不允许将根层和根层设置为存储组）。

#### 数据类型

```
IoTDB总共支持六种数据类型：
BOOLEAN（布尔值）
INT32（整数）
INT64（长整数）
FLOAT（单精度浮点数）
DOUBLE（双精度浮点数）
TEXT（字符串）
```

### 五、总结

总体来说，就目前收集到的资料来看。

1.就物联网时序数据存储的需求来说，除IoTDB和influxDB之外的其它时序数据库可能都是不合格的。
2.由于使用场景与influxDB相似，IoTDB在数据的逻辑分类及存储引擎上与influxDB都是极为相似的，但对其有性能优势。
3.我没有找到IoTDB中关于自动删除数据（数据轮转）的说明，过期数据自动删除是influxDB的一大特点。
4.IoTDB-server部署需要java环境，IoTDB-client部署有java版本和golang版本（相比其它的DB，这是很少的）
5.IoTDB并不仅仅做了数据库，他们应该对整个IoT数据从采集到存储处理都有相应的方案和优化，并提供了多种工具。

#### influxDB与IoTDB数据分类逻辑对比

![image-20210303150822479](.\img\InfluxDB数据.png)

如上图，influxDB将环境中的`网络设备`用`tag-sets`进行分类，将同一个`网络设备`产出的同一个`measurement(指标)`叫做一个`series(簇)`。

而IoTDB对其进行了优化，IoTDB是按`Storage Group(储存组)`进行数据存储的，用户可以人为将多个`series(簇)`合并为`Storage Group(储存组)`进行存储。

```
ps：显然，根据实际环境情况（或预期）设置合理数量的存储组可以提高IoTDB的整体表现。
```

> ```
> ps：为了方便说明，笔者此处挪用了influxDb中的series概念，实际上IoTDB中并没有此概念。并且IoTDB中的measurement叫sensor(测点)。
> ```



拓展资料：

https://iotdb.apache.org/UserGuide/V0.11.x/Overview/Architecture.html

https://www.slidestalk.com/ApachePulsar/ApacheIoTDB59230