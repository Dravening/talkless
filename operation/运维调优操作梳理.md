# 运维调优操作梳理

### 系统查询操作

1.CoreDump文件存放位置

Core Dump文件是指程序运行时发生错误或崩溃时产生的一种错误报告文件。

以linux 5.4.224-1.el7.elrepo.x86_64 版本为例

```shell
[root@tcosmo-sh01 ~]# cat /proc/sys/kernel/core_pattern 
|/usr/lib/systemd/systemd-coredump %P %u %g %s %t %c %e
```

2.tcpDump

tcpdump是一个在Linux和Unix操作系统上的命令行网络分析工具。它可以嗅探并捕获网络数据包，并且能够分析和显示这些数据，以便于网络问题诊断和性能调优。

```
# 获取本机8021端口的tcp数据包
[root@xxx ~]# tcpdump -i team0 tcp port 8021 -A | grep -E "(GET|POST|HTTP\/1\.1|Content-Type)"
```

3.iotop / iostat

```
# iotop可以将进程按磁盘使用率排序
# iostat可以展示tps，这个指标可以一定程度上认为跟cpu上下文切换有关
[root@tcosmo-sh01 perf]# iostat
Linux 5.4.224-1.el7.elrepo.x86_64 (tcosmo-sh01)         08/04/2023      _x86_64_        (40 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           3.56    0.04    1.37    0.01    0.00   95.02

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda              36.21        52.45       370.10  896736664 6327330548
```

4.安装各类工具

```
yum install sysstat -y
```

```
curl https://repos.baslab.org/rhel/7/bpftools/bpftools.repo --output /etc/yum.repos.d/bpftools.repo
yum install bpftrace bpftrace-tools bpftrace-doc bcc-static bcc-tools
```



### perf工具使用

1.火焰图

```
# 准备工具
yum install perf -y
yum install git
git clone https://github.com/brendangregg/FlameGraph.git
```

```
# perf 采集指定pid的数据, 会在当前目录生成一个perf.data文件
perf record -F 99 -a -g -- sleep 60
perf record -F 99 -p <PID> -g -- sleep 60
```

```
# 生成火焰图
perf script --header > out.stacks
./FlameGraph/stackcollapse-perf.pl < out.stacks | ./FlameGraph/flamegraph.pl --hash > out.svg
# 简化
perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl > process.svg
```

2.上下文切换&调度器延时

```
[root@tcosmo-sh01 perf]# perf sched latency

 -------------------------------------------------------------------------------------
Task                  |   Runtime ms  | Switches | Avg delay ms    | Max delay ms    |
--------------------------------------------------------------------------------------
server:(34)           |     10.531 ms |       51 | avg:  50.890 ms | max: 499.838 ms |
operator:(29)         |     74.814 ms |       63 | avg:  33.244 ms | max: 191.127 ms |
alertmanager:(27)     |     72.509 ms |       46 | avg:  21.937 ms | max:  99.449 ms |
titanagent:(30)       |   1311.266 ms |       48 | avg:   4.796 ms | max:  51.464 ms |
iptables-save:(2)     |     16.756 ms |        2 | avg:   1.756 ms | max:   3.505 ms |
kubelet:(42)          |   1817.801 ms |      178 | avg:   0.113 ms | max:   3.681 ms |
containerd:(129)      |   4023.706 ms |      399 | avg:   0.078 ms | max:   7.323 ms |
flink-scheduler:(2)   |     80.551 ms |        3 | avg:   0.042 ms | max:   0.127 ms |
kube-proxy:(37)       |    269.239 ms |       72 | avg:   0.037 ms | max:   0.992 ms |
mongosh:(12)          |    917.941 ms |       13 | avg:   0.027 ms | max:   0.229 ms |
mongosh mongodb:(12)  |   5726.826 ms |       33 | avg:   0.021 ms | max:   0.337 ms |
```

其中Switches列代表了上下文切换的次数，delay代表了调度器延时时间（即在cpu队列中等待的时间）

3.PMC(硬件事件)

```
[root@tcosmo-sh01 perf]# perf stat -a -- sleep 10

 Performance counter stats for 'system wide':

        400,043.99 msec cpu-clock                 #   39.987 CPUs utilized          
           500,795      context-switches          #    0.001 M/sec                  
             9,443      cpu-migrations            #    0.024 K/sec                  
           276,254      page-faults               #    0.691 K/sec                  
    40,465,859,743      cycles                    #    0.101 GHz                    
    49,333,687,598      instructions              #    1.22  insn per cycle         
    10,471,620,081      branches                  #   26.176 M/sec                  
       181,383,338      branch-misses             #    1.73% of all branches        

      10.004372716 seconds time elapsed
```

其中'insn per cycle'为IPC（每周期指令数），可以衡量cpu的运行情况